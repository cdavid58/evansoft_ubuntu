{% extends '../base.html' %}
{% block content %}

<div class="page-header">
	<div class="row">
		<div class="col-md-6 col-12 mb-2 text-center text-md-left">
			<div class="title">
				<button class="btn btn-primary modal_resolution">Actualizar Resolución</button>
			</div>
		</div>
		<div class="col-md-6 col-12 mb-2 text-center text-md-right">
			<div class="title">
				<a class="btn btn-primary" href="{% url 'List_Branch' %}" role="button">Lista de sucursales</a>
			</div>
		</div>
	</div>
</div>

<div class="row">
	<div class="col-xl-4 col-lg-4 col-md-4 col-sm-12 mb-30">
		<div class="pd-20 card-box height-100-p" style="min-height: 510px;">
			<div class="profile-info">
				<h5 class="mb-20 h5 text-blue">Información de la Sucursal</h5>
				<ul>
					<li>
						<span>Nombre:</span>
						{{data.business_name|title}}
					</li>
					<li>
						<span>Correo Electrónico:</span>
						{{data.email}}
					</li>
					<li>
						<span>Número de Tlf:</span>
						{{data.phone_1}} - {{data.phone_2}}
					</li>
					<li>
						<span>Valor de Apertura:</span>
						{{data.opening_balance}}
					</li>
					<li>
						<span>Dirección:</span>
						{{data.address}}
					</li>
					<li>
					    <span for="discountSelect"><strong>Descuento:</strong></span>
					    <select id="discountSelect" name="discount" class="form-control col-3">
					        <option value="true" {% if data.discount %}selected{% endif %}>Sí</option>
					        <option value="false" {% if not data.discount %}selected{% endif %}>No</option>
					    </select>
					</li>

					<li>
						<span>Estatus Sucursal:</span>
						{% if data.block %}
							Esta bloquada la sucursal.
						{% else %}
							Esta en operación
						{% endif %}
					</li>
					<li>
						<span>Tipo de Resolución:</span>
						{% for i in data.resolution %}
							{{ i.type_document__name }}
							{% if not forloop.last %} - {% endif %}
						{% endfor %}

					</li>
					<li>
						<span>Tipo de Licencia:</span>
						{{data.license.name}}
					</li>
				</ul>
			</div>
			<div class="d-none d-md-block" style="height: 640px;"></div>
		</div>
	</div>
	<div class="col-xl-8 col-lg-8 col-md-8 col-sm-12 mb-30">
		<div class="card-box height-100-p overflow-hidden">
			<div class="profile-tab height-100-p">
				<div class="tab height-100-p">
					<ul class="nav nav-tabs customtab" role="tablist">
						<li class="nav-item">
							<a class="nav-link active" data-toggle="tab" href="#tasks" role="tab">Configuración</a>
						</li>
					</ul>
					<div class="tab-content">
						<div class="tab-pane fade show active" id="tasks" role="tabpanel">
							<div class="pd-20 profile-task-wrap">
								<div class="container pd-0">
									<form class="data_company">
										<div class="row">
											<div class="col-md-12 col-sm-12">
												<div class="form-group">
													<label>Nombre de Sucursal</label>
													<input type="text" value="{{data.business_name}}" name="business_name" class="form-control">
												</div>
											</div>
										</div>
										<div class="row">
											<div class="col-md-6 col-sm-12">
												<div class="form-group">
													<label>Dirección</label>
													<input type="text" value="{{data.address}}" name="address" class="form-control">
												</div>
											</div>
											<div class="col-md-6 col-sm-12">
												<div class="form-group">
													<label>Correo Electrónico</label>
													<input type="text" value="{{data.email}}" name="email_branch" class="form-control">
												</div>
											</div>
										</div>
										<div class="row">
											<div class="col-md-3 col-sm-12">
												<div class="form-group">
													<label>Teléfono 1</label>
													<input type="text" value="{{data.phone_1}}" name="phone_1" class="form-control">
												</div>
											</div>
											<div class="col-md-3 col-sm-12">
												<div class="form-group">
													<label>Teléfono 2</label>
													<input type="text" value="{{data.phone_2}}" name="phone_2" class="form-control">
												</div>
											</div>
											<div class="col-md-3 col-sm-12">
												<div class="form-group">
													<label>Valor apertura de caja</label>
													<input type="text" value="{{data.opening_balance}}" name="opening_balance" class="form-control">
												</div>
											</div>
											<div class="col-md-2 col-sm-12">
												<div class="form-group">
													<label>Stock mínimo</label>
													<input type="number" value="{{data.limited_inventory}}" name="limited_inventory" class="form-control">
												</div>
											</div>
										</div>
										<hr>
										<h5 class="mb-20 h5 text-blue">Resoluciones</h5>
										{% for i in data.resolution %}
											<h5 class="mb-20 h5 text-blue">{{i.type_document__name}}</h5>
											<div class="row">
												<div class="col-md-2 col-sm-12">
													<div class="form-group">
														<label>Prefijo</label>
														<input type="text" disabled value="{{i.prefix}}" class="form-control">
													</div>
												</div>
												<div class="col-md-3 col-sm-12">
													<div class="form-group">
														<label>Fecha Desde</label>
														<input type="text" disabled value="{{i.date_from}}" class="form-control">
													</div>
												</div>
												<div class="col-md-3 col-sm-12">
													<div class="form-group">
														<label>Fecha Hasta</label>
														<input type="text" disabled value="{{i.date_to}}" class="form-control">
													</div>
												</div>
												<div class="col-md-3 col-sm-12">
													<div class="form-group">
														<label>N° de Resolución</label>
														<input type="number" disabled value="{{i.resolution}}" class="form-control">
													</div>
												</div>
											</div>
											<div class="row">
												<div class="col-md-2 col-sm-12">
													<div class="form-group">
														<label>Expira en</label>
														<input type="text" disabled value="{{i.days_remaining}}" style="font-size: 14px;" class="form-control">
													</div>
												</div>
												<div class="col-md-3 col-sm-12">
													<div class="form-group">
														<label>Desde</label>
														<input type="text" disabled value="{{i.from}}" class="form-control">
													</div>
												</div>
												<div class="col-md-3 col-sm-12">
													<div class="form-group">
														<label>Hasta</label>
														<input type="text" disabled value="{{i.to}}" class="form-control">
													</div>
												</div>
												<div class="col-md-3 col-sm-12">
													<div class="form-group">
														<label>Fecha Resolución</label>
														<input type="text" disabled value="{{i.resolution_date}}" class="form-control">
													</div>
												</div>
											</div>
											{% if not forloop.last %} <hr> {% endif %}

										{% endfor %}
										<hr>
										<h5 class="mb-20 h5 text-blue">Licencia</h5>
										<div class="row">
											<div class="col-md-3 col-sm-12">
												<div class="form-group">
													<label>Tipo de Licencia</label>
													<input type="text" disabled value="{{data.license.name}}" class="form-control">
												</div>
											</div>
											<div class="col-md-2 col-sm-12">
												<div class="form-group">
													<label>Expira en</label>
													<input type="text" disabled value="{{data.license.days_left}}" class="form-control">
												</div>
											</div>
											<div class="col-md-2 col-sm-12">
												<div class="form-group">
													<label>Facturas</label>
													<input type="text" disabled value="{{data.license.qty_docs_invoice}}" class="form-control">
												</div>
											</div>
											<div class="col-md-2 col-sm-12">
												<div class="form-group">
													<label>Nominas</label>
													<input type="number" disabled value="{{data.license.qty_docs_payroll}}" class="form-control">
												</div>
											</div>
											<div class="col-md-2 col-sm-12">
												<div class="form-group">
													<label>Evento Radian</label>
													<input type="number" disabled value="{{data.license.qty_docs_radian}}" class="form-control">
												</div>
											</div>
											<div class="col-md-3 col-sm-12">
												<div class="form-group">
													<label>Documento Soporte</label>
													<input type="number" disabled value="{{data.license.qty_docs_ds}}" class="form-control">
												</div>
											</div>
										</div>
										<br>
										<div class="row">
											<div class="col-md-6 col-12 mb-2 text-center text-md-left">
												<a class="btn btn-primary update_branch" href="javascript:void(0);" role="button">Actualizar Sucursal</a>
											</div>
											<div class="col-md-6 col-12 mb-2 text-center text-md-right">
												<a class="btn btn-primary" href="{% url 'List_Branch' %}" role="button">Lista de sucursales</a>
											</div>
										</div>

									</form>
								</div>
							</div>
						</div>
						<!-- Setting Tab End -->
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Modal para actualizar resolución -->
<div class="modal fade" id="modalResolution" tabindex="-1" role="dialog" aria-labelledby="modalResolutionLabel" aria-hidden="true">
	<div class="modal-dialog modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header bg-primary text-white">
				<h5 class="modal-title" id="modalResolutionLabel text-white" style="color: white !important;">Actualizar Resolución</h5>
				<button type="button" class="close text-white" data-dismiss="modal" aria-label="Cerrar">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<form id="form_resolution">
					<div class="form-group">
						<label for="selectResolution">Tipo de Resolución</label>
						<select class="form-control type_resolution" id="selectResolution" name="type_resolution">
							<option value="">Seleccione una opción</option>
							{% for i in type_document %}
								<option value="{{i.code}}">{{i.name}}</option>
							{% endfor %}
							<!-- Agrega más si necesitas -->
						</select>
					</div>
					<div class="form-group">
						<label for="valueResolution">Valor numérico</label>
						<input type="number" class="form-control value_resolution" id="valueResolution" name="value_resolution" placeholder="Ingrese un número">

						<label for="valuePrefix" hidden>Prefijo</label>
						<input type="text" class="form-control value_prefix" id="valuePrefix" name="value_prefix" placeholder="EJ: Ingrese un prefijo de al menos 4 dígitos." hidden>
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
				<button type="button" class="btn btn-primary" id="saveResolution">Guardar</button>
			</div>
		</div>
	</div>
</div>


{% endblock %}
{% block script %}
	<script>
		$(document).ready(function(){

			$(".modal_resolution").click(function(){
				$("#modalResolution").modal("show");
			})

			$("#selectResolution").change(function(){
				const accepted_not_document_type = [99, 4, 5];
				const selectedValue = parseInt($(this).val());

				if (accepted_not_document_type.includes(selectedValue)) {
					// Mostrar prefijo y ocultar valor numérico
					$("#valuePrefix").removeAttr("hidden");
					$("label[for='valuePrefix']").removeAttr("hidden");

					$("#valueResolution").attr("hidden", true);
					$("label[for='valueResolution']").attr("hidden", true);
				} else {
					// Mostrar valor numérico y ocultar prefijo
					$("#valueResolution").removeAttr("hidden");
					$("label[for='valueResolution']").removeAttr("hidden");

					$("#valuePrefix").attr("hidden", true);
					$("label[for='valuePrefix']").attr("hidden", true);
				}
			});


			$("#discountSelect").change(function () {
				console.log("Hola")
			    var selectedValue = $(this).val();
			    console.log(selectedValue)
			    $.ajax({
			        url: "{% url 'Activate_Discount' %}",
			        type: "POST",
			        data: {csrfmiddlewaretoken: '{{ csrf_token }}'},
			        success: function (response) {
			            if (response.result) {
			                $("#discountSelect").val(response.state.toString());
			                Swal.fire({
								toast: true,
								position: 'top-end',
								icon: 'success',
								title: "Descuento " + (response.state ? "activado" : "desactivado"),
								showConfirmButton: false,
								timer: 2000,
								timerProgressBar: true,
							});
			            } else {
			                Swal.fire({
								toast: true,
								position: 'top-end',
								icon: 'error',
								title: "Ocurrió un error: " + response.error,
								showConfirmButton: false,
								timer: 2000,
								timerProgressBar: true,
							});
			            }
			        },
			        error: function (xhr, status, error) {
			            console.error("Error en AJAX:", error);
			        }
			    });
			});

			$("#saveResolution").click(function() {
				$(".text_send_email").text('Espere mientras actualizamos la resolución.');
				var modalLoader = new bootstrap.Modal(document.getElementById('loader1'), {
				  keyboard: false,
				  backdrop: 'static'
				});
				modalLoader.show();
				const data = {
					type_document: $("#selectResolution").val(),
					resolution_number: $("#valueResolution").val(),
					prefix: $("#valuePrefix").val(),
					branch_id: {{ data.id|safe }}
				};

				console.log("Datos a enviar:", data);
				$("#modalResolution").modal("hide");
				$.ajax({
					url: '{% url "Update_Resolution_PDF_Dian" %}',
					type: 'POST',
					data: JSON.stringify(data),
					contentType: 'application/json',
					headers: {
						"X-CSRFToken": "{{ csrf_token }}"
					},
					success: function(response) {
						console.log("Respuesta:", response);

						if (response.result) {

							Swal.fire({
								icon: 'success',
								title: 'Resolución actualizada',
								text: response.message || 'Se guardó la nueva resolución correctamente.',
								confirmButtonText: 'OK'
							}).then((result) => {
								if (result.isConfirmed) {
									location.reload(true);
								}
							});
							
						} else {
							Swal.fire({
								icon: 'warning',
								title: 'Atención',
								text: response.message || 'No se pudo actualizar la resolución.',
								confirmButtonText: 'OK'
							});
						}
						modalLoader.hide()
					},
					error: function(xhr, status, error) {
						console.error("Error:", error);
						Swal.fire({
							icon: 'error',
							title: 'Error',
							text: 'Ocurrió un error al actualizar la resolución.',
							confirmButtonText: 'OK'
						});
						modalLoader.hide()
					}
				});
			});


			$(".update_branch").click(function () {
				let formData = $(".data_company").serializeArray();
				formData.push({ name: "branch_id", value: "{{request.session.branch_id}}" });
				formData.push({ name: "employee_id", value: "{{request.session.pk_employee}}" });

				let formObject = {};
				formData.forEach(function(item) {
					formObject[item.name] = item.value;
				});
				let csrftoken = $('meta[name="csrf-token"]').attr('content');

				$.ajax({
					url: '{% url "Update_Branch" %}',
					type: "POST",
					data: JSON.stringify(formObject),
					contentType: "application/json",
					headers: {
						"X-CSRFToken": "{{ csrf_token }}"
					},
					success: function (e) {
						console.log(e);
						if (e.result) {
							Swal.fire({
								icon: 'success',
								title: 'Datos actualizados',
								text: 'Los datos de la sucursal se actualizaron correctamente.',
								confirmButtonText: 'OK'
							}).then((result) => {
								if (result.isConfirmed) {
									location.reload(true);
								}
							});
						} else {
							Swal.fire({
								icon: 'error',
								title: 'Oopss.. Algo salió mal.',
								text: e.message,
								confirmButtonText: 'OK'
							});
						}
					}
				});
			});

		})
	</script>
{% endblock %}
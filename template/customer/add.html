{% extends '../base.html' %}
{% block content %}
<style>
	/* Resalta el label si el campo está vacío */
	.form-group label {
	    font-weight: 600;
	    transition: color 0.3s ease-in-out;
	}

	.form-group input:focus {
	    border-color: #007bff !important;
	    box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
	}

	/* Campo obligatorio vacío = borde rojo */
	.form-group .required:invalid {
	    border-color: red !important;
	}

	/* Cambia el color del label si el campo está vacío */
	.form-group .required:invalid + label {
	    color: red;
	}

	.error-message {
	    display: none;
	    font-size: 0.85rem;
	    margin-top: 5px;
	}

	.is-invalid {
	    border-color: red !important;
	}

	.is-invalid + .error-message {
	    display: block;
	}


</style>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Título con ícono de información -->
<div class="row mb-2">
    <div class="col-md-6 col-sm-12">
        <div class="title d-flex align-items-center">
            <h4 class="mb-0">🚀 Vamos a crear un cliente!</h4>&nbsp; &nbsp; 
            <span class="ms-2" data-bs-toggle="tooltip" data-bs-placement="right" title="Más información sobre clientes">
                <i class="fas fa-info-circle text-primary" style="cursor: pointer; font-size: 1.4rem;" data-bs-toggle="modal" data-bs-target="#infoModal"></i>
            </span>
        </div>
    </div>
    <div class="col-md-6 col-sm-12 text-end">
        <a class="btn btn-primary create_client" href="{% url 'List_Customer' %}" role="button">Lista de clientes</a>
    </div>
</div>

<!-- Modal Bootstrap de información -->
<div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-3 shadow">
      
      <!-- Encabezado del modal -->
      <div class="modal-header">
        <h5 class="modal-title d-flex align-items-center" id="infoModalLabel">
          <i class="fas fa-info-circle text-primary me-2"></i>&nbsp; Información sobre clientes
        </h5>
      </div>

      <!-- Cuerpo del modal -->
      <div class="modal-body text-justify" style="line-height: 1.6;">
        La <strong>DIAN</strong> anunció que, a partir de abril de 2025, se podrán generar facturas electrónicas usando solo el tipo y número de documento del comprador, <strong>sin necesidad de solicitar información adicional</strong>.

        <br><br>Este nuevo servicio estará disponible para todos los facturadores:
        <ul>
          <li>Usuarios del servicio gratuito de la DIAN</li>
          <li>Software propio</li>
          <li>Proveedores tecnológicos</li>
        </ul>

        <p><strong>Importante:</strong> No se podrá solicitar dirección, teléfono ni RUT. El sistema completará automáticamente el <em>nombre</em> y el <em>correo electrónico</em> del comprador gracias a la integración entre la DIAN y la SIC.</p>
      </div>

      <!-- Pie del modal -->
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>

    </div>
  </div>
</div>


<!-- Tooltip Bootstrap (actívalo en tu script JS) -->
<script>
    $(function () {
        $('[data-bs-toggle="tooltip"]').tooltip()
    });
</script>



<form class="form_data">
	<div class="row">
	    <div class="col-md-2 col-sm-12">
	        <div class="form-group">
	            <label for="code">Documento de Identificación</label>
	            <input type="number" id="code" name="identification_number" class="form-control identification_number required" autofocus placeholder="Ej: 12345678">
	            <small class="error-message text-danger"></small>
	        </div>
	    </div>

	    <div class="col-md-4 col-sm-12">
	        <div class="form-group">
	            <label for="name">Razón Social</label>
	            <input type="text" id="name" name="name" class="form-control" placeholder="Ej: Empresa S.A.">
	            <small class="error-message text-danger"></small>
	        </div>
	    </div>

	    <div class="col-md-2 col-sm-12">
	        <div class="form-group">
	            <label for="phone">Teléfono</label>
	            <input type="tel" id="phone" name="phone" class="form-control" placeholder="Ej: 3123456789"
	                pattern="^\d{7,10}$" maxlength="10" minlength="7">
	            <small class="error-message text-danger"></small>
	        </div>
	    </div>

	    <div class="col-md-4 col-sm-12">
	        <div class="form-group">
	            <label for="address">Dirección</label>
	            <input type="text" id="address" name="address" class="form-control" placeholder="Ej: Calle 123 #45-67">
	            <small class="error-message text-danger"></small>
	        </div>
	    </div>
	</div>


	<div class="row">
		<div class="col-md-4 col-sm-12">
	        <div class="form-group">
	            <label for="email">Correo Electronico</label>
	            <input type="text" id="email" name="email" class="form-control" placeholder="Ej: Calle 123 #45-67">
	            <small class="error-message text-danger"></small>
	        </div>
	    </div>
		<div class="col-md-2 col-sm-12">
	        <div class="form-group">
	            <label for="merchant_registration">Registro Mercantil</label>
	            <input type="text" id="merchant_registration" name="merchant_registration" class="form-control" placeholder="0000000-00">
	        </div>
	    </div>
		<div class="col-md-3 col-12">
		    <div class="form-group">
		        <label for="type_document_identification">Tipo de Documento</label>
		        <select id="type_document_identification" name="type_document_identification" class="custom-select">
		            <option value="">Seleccione...</option>
		            {% for i in type_document_identification %}
		                <option value="{{i.code}}">{{i.name}}</option>
		            {% endfor %}
		        </select>
		        <small class="error-message text-danger"></small>
		    </div>
		</div>

		<div class="col-md-3 col-12">
		    <div class="form-group">
		        <label for="type_organization">Tipo de Organización</label>
		        <select id="type_organization" name="type_organization" class="custom-select">
		            <option value="">Seleccione...</option>
		            {% for i in type_organization %}
		                <option value="{{i.code}}">{{i.name}}</option>
		            {% endfor %}
		        </select>
		        <small class="error-message text-danger"></small>
		    </div>
		</div>

		<div class="col-md-3 col-12">
		    <div class="form-group">
		        <label for="type_regime">Tipo de Régimen</label>
		        <select id="type_regime" name="type_regime" class="custom-select">
		            <option value="">Seleccione...</option>
		            {% for i in type_regime %}
		                <option value="{{i.code}}">{{i.name}}</option>
		            {% endfor %}
		        </select>
		        <small class="error-message text-danger"></small>
		    </div>
		</div>

		<div class="col-md-3 col-12">
		    <div class="form-group">
		        <label for="type_liability">Tipo de Responsabilidad</label>
		        <select id="type_liability" name="type_liability" class="custom-select">
		            <option value="">Seleccione...</option>
		            {% for i in type_liability %}
		                <option value="{{i.code}}">{{i.name}}</option>
		            {% endfor %}
		        </select>
		        <small class="error-message text-danger"></small>
		    </div>
		</div>

		<div class="col-md-3 col-12">
		    <div class="form-group">
		        <label for="municipality">Municipio</label>
		        <select id="municipality" name="municipality" class="custom-select">
		            <option value="">Seleccione...</option>
		            {% for i in municipality %}
		                <option value="{{i.code}}">{{i.name}}</option>
		            {% endfor %}
		        </select>
		        <small class="error-message text-danger"></small>
		    </div>
		</div>

	</div>
	<div class="row">
		<div class="col-md-2 col-sm-12">
			<a class="btn btn-primary save_customer" href="javascript:void(0);" role="button">Crear Cliente</a>
		</div>
	</div>
</form>
							

{% endblock %}
{% block script %}

	<script>
		$(document).ready(function () {
		    let phoneInput = $("input[name='phone']");

		    // Validación de teléfono
		    phoneInput.on("input", function () {
		        let value = $(this).val().replace(/\D/g, ""); // Solo números
		        $(this).val(value);
		    });

		    phoneInput.on("blur", function () {
		        let phoneRegex = /^(?:\d{7}|\d{10})$/; // Solo 7 o 10 dígitos permitidos
		        let isValid = phoneRegex.test($(this).val());

		        $(this).next(".phone-error").remove(); // Elimina mensaje anterior
		        if (!isValid) {
		            $(this).addClass("is-invalid");
		            $(this).after('<div class="text-danger phone-error" style="font-size: 12px;">⚠️ Ingrese un número de 7 o 10 dígitos</div>');
		        } else {
		            $(this).removeClass("is-invalid");
		        }
		    });

		    // Validación de inputs y selects
		    $(".required").on("blur change", function () {
		        let input = $(this);
		        let errorMessage = input.next(".error-message");

		        if (!input.val().trim()) {
		            input.addClass("is-invalid");
		            errorMessage.text("⚠️ Este campo es obligatorio").show();
		        } else {
		            input.removeClass("is-invalid");
		            errorMessage.hide();
		        }
		    });


		    $(".save_customer").click(function(){
			    if(parseInt($(".identification_number").val()) > 900000000 && $("#type_document_identification").val() != 6){
			        Swal.fire({
			            icon: "error",
			            title: "Tipo de documento errado",
			            text: "Ha ingresado un NIT, por favor cambie el tipo de documento a NIT.",
			            confirmButtonText: "OK"
			        });
			        return;
			    }

			    if(parseInt($(".identification_number").val()) > 900000000 && $("#type_document_identification").val() == 6 && $("#type_organization").val() != 1){
			        Swal.fire({
			            icon: "error",
			            title: "Tipo de organización errado",
			            text: "Ha ingresado un NIT, por favor cambie el tipo de organizacion a Juridico.",
			            confirmButtonText: "OK"
			        });
			        return;
			    }

			    let form = {};
			    $(".form_data").serializeArray().forEach(field => {
			        form[field.name] = field.value;
			    });

			    $.ajax({
			        url: "{% url 'Save_Customer' %}",
			        type: "POST",
			        contentType: "application/json", // <- asegúrate que esté
			        data: JSON.stringify(form),
			        headers: {
			            "X-CSRFToken": "{{ csrf_token }}"
			        },
			        success: function(response){
			            console.log("✅ Respuesta del servidor:", response);

			            if(response.result){
			                Notification("success", "✅ Cliente creado con éxito.", response.message, "OK");
			                $(".form_data")[0].reset();
			                $(".branchs").val(null).trigger("change.select2");
			                $("select").val("").trigger("change.select2");
			            } else {
			                Notification("error", "Oopss.. Algo salió mal.", response.message, "OK");
			            }
			        },
			        error: function(xhr, status, error){
			            console.error("🚨 Error en la petición:", status, error);
			            Notification("error", "🚨 Error en la petición", status, "OK");
			        }
			    });
			});

		});
	</script>
{% endblock %}
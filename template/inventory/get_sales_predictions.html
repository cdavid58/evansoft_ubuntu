{% extends '../base.html' %}
{% block content %}
<style>
	.dataTables_paginate {
	    overflow-x: auto;
	    white-space: nowrap;
	    display: flex;
	    justify-content: center;
	}

	.dataTables_paginate .pagination {
	    flex-wrap: nowrap;
	}

	@media screen and (max-width: 400px) {
	    .dataTables_paginate {
	        font-size: 12px;
	    }
	}
</style>
<div class="row mb-2">
	<div class="col-md-6 col-sm-12">
		<div class="title">
			<h4>Productos m치s vendidos</h4>
		</div>
	</div>
	<div class="col-md-6 col-sm-12 text-right">
		<select class="custom-select col-6 branch">
			<option selected="" value="0">Elija Sucursal</option>
			{% for i in list_branch %}
				<option value="{{i.id}}">{{i.business_name}}</option>
			{% endfor %}
		</select>
	</div>
</div>

<div class="card-box mb-30 p-2">
	<div class="pb-20">
		<div class="table-responsive">
			<table class="data-table table table-stripe hover nowrap" style="width:100%">
		        <thead>
		            <tr>
		                <th class="table-plus datatable-nosort">C칩digo</th>
		                <th>Producto</th>
		                <th>Total Vendidos</th>
		            </tr>
		        </thead>
		        <tbody></tbody>
		    </table>
		</div>
	</div>
</div>
{% endblock %}

{% block script %}
<script>
	$(document).ready(function () {
		let branch_id = null
		$(".branch").change(function () {
		    branch_id = $(this).val().trim();

		    if (branch_id == 0) {
		        Swal.fire({
		            icon: "warning",
		            title: "Sucursal no seleccionada",
		            text: "Por favor, seleccione una sucursal para ver los productos m치s vendidos.",
		            confirmButtonText: "Entendido"
		        });

		        if ($.fn.DataTable.isDataTable('.table')) {
		            let table = $('.table').DataTable();
		            table.clear().draw();
		        }
		        return;
		    }

		    if ($.fn.DataTable.isDataTable('.table')) {
		        $('.table').DataTable().destroy();
		    }

		    $('.table').DataTable({
		        responsive: true,
		        serverSide: true,
		        processing: true,
		        searching: true,
		        pagingType: "simple_numbers",
		        ajax: {
		            url: "{% url 'Get_Sales_Predictions' %}",
		            type: "GET",
		            headers: { "X-Requested-With": "XMLHttpRequest" },
		            data: function (d) {
		                d.pk_branch = branch_id;
		                d.search = d.search || {};
		                d.search.value = d.search.value || '';
		            },
		            dataSrc: function (json) {
		                console.log("游댳 Respuesta del servidor:", json);
		                return json.data || [];
		            }
		        },
		        columns: [
		            { data: "codigo", title: "C칩digo", className: "table-plus" },
		            { data: "producto", title: "Producto" },
		            { data: "total_sold", title: "Total Vendidos" },
		        ],
		        lengthMenu: [10, 20, 30, 40, 50],
		        language: {
		            url: "https://cdn.datatables.net/plug-ins/1.11.5/i18n/es-ES.json"
		        },
		        drawCallback: function () {
		            console.log('游댃 Tabla actualizada con nueva data');
		        }
		    });
		});

	});
</script>
{% endblock %}
